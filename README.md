# :warning: work in progress

Maintaining CI for many homogenous repositories is a huge pain.

Dhall provides (I believe) a very well-fitting solution to this problem, because it's:

 - simple (much easier to learn than a full programming language)
 - distributed (import code straight from the internet)
 - strongly typed (more errors at compile time = less error at the end of a slow CI build)

# Components:

This solution is intentionally decentralised, because:

 - a single repository trying to solve every use case is not going to scale well, and I don't want to have to curate libraries for ecosystems I have never used
 - dhall's remote imports are low friction compared to most languages, so there's little downside

By building it decentralised in the first place, anyone can contribute to the ecosystem by simply following the common patterns.

If you build your own component and want people to discover it, raise an issue / PR and I'll happily link it here:

- [timbertson/dhall-ci](https://github.com/timbertson/dhall-ci) (this repo): core types used by many modules (bash, workflow, etc)
- [timbertson/dhall-ci-git](https://github.com/timbertson/dhall-ci-git): committing, diffing and version management
- [timbertson/dhall-ci-dhall](https://github.com/timbertson/dhall-ci-dhall): linting, formatting, freezing

# Rendering files:

The components of `dhall-ci` are useful for defining things (workflows, scripts, etc). But that's not sufficient on its own. [timbertson/dhall-render](https://github.com/timbertson/dhall-render) is a tool which allows you to define a whole set of files, and have them rendered out as YAML / JSON / text.

To initialize dhall-render in a repository, run:

```
curl -sSL https://raw.githubusercontent.com/timbertson/dhall-render/master/bootstrap.sh | bash
```

## Suggested usage:

The recommended way to import `dhall-ci-*` functionality is to bundle the modules you want into a single export, like so:

```dhall
-- dhall/CI.dhall
https://raw.githubusercontent.com/timbertson/dhall-ci/COMMIT_OR_TAG/package.dhall //\\
{
	, Git = https://raw.githubusercontent.com/timbertson/dhall-ci-git/COMMIT_OR_TAG/package.dhall
	, Dhall = https://raw.githubusercontent.com/timbertson/dhall-ci-dhall/COMMIT_OR_TAG/package.dhall
}
```

(you should `dhall freeze --inplace dhall/CI.dhall` once you've filled in the relevant commits / tags)

Then, if you're using `dhall-render`, you would use it like so:

# Contents:

This repo contains some core types and functionality which is referenced by multiple components. For templates, helpers and opinionated templates you should also import the various components above.

### Bash:

An overly simple, leaky abstraction for scripts.

This makes no attempt at understanding the syntax or escaping rules for bash, it's really just "a list of lines".

It's not useful for composing expressions, but it _is_ useful for composing commands, conditionals, etc.

It has some opinions, namely that every script shall use `set -eu -o pipefail`. The `renderScript` enforces this, and snippets may not do the right thing if you use them in a script without these settings.

### Bash.Dhall

Dhall commands for `GithubWorkflow.Dhall`

### Bash.Git

Git commands for `GithubWorkflow.Git`

### GithubWorkflow:

An alias to [github-actions-dhall](https://github.com/regadas/github-actions-dhall)'s `schemas.dhall`.

### GithubWorkflow.Git

Snippets for common git actions:

 - fail if there are uncommitted changes
 - make a commit as the github action user
 - create version tags using [timbertson/autorelease-tagger-action](https://github.com/timbertson/autorelease-tagger-action)
 - manage a dangling commit for given branches/tags containing autogenerated changed

### GithubWorkflow.Dhall

Workflow snippets for doing things with dhall:

 - formatting
 - evaluating
 - freezing

### GithubWorkflow.SelfUpdate

Self update based on [timbertson/self-update-action](https://github.com/timbertson/self-update-action)

 - fail if there are uncommitted changes
 - make a commit as the github action user
 - create version tags using [autorelease-tagger-action](https://github.com/timbertson/autorelease-tagger-action)
 - manage a dangling commit for given branches/tags containing autogenerated changed
